<?xml version="1.0" encoding="UTF-8"?>
<testcase 
    id="ehmi_schema_validation" 
    xmlns="http://www.gitb.com/tdl/v1/" 
    xmlns:gitb="http://www.gitb.com/core/v1/" 
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
    xsi:schemaLocation="http://www.gitb.com/tdl/v1/ ../../../testbedSchemas/gitb_tdl.xsd">    

    <metadata>
        <gitb:name>Basic EHMI Schema Validation XML</gitb:name>
        <gitb:version>1.0</gitb:version>
        <gitb:description>The most basic test: Ensuring that the data conforms to the schema</gitb:description>
    </metadata>

    <imports>
        <artifact type="schema" encoding="UTF-8" name="EHMISBDHSchema">resources/EHMI/ehmiSbdhStandardBusinessDocumentHeader.xsd</artifact>
        <artifact type="binary" encoding="UTF-8" name="schematron">resources/EHMI/schematrons/customAssertions.sch</artifact>
    </imports>

    <actors>
        <gitb:actor id="EHMICorrespondent" name="EHMI Correspondent" role="SUT"/>
        <gitb:actor id="SimulatedEHMICorrespondent" name="Simulated EHMI Correspondent"/>
    </actors>

    <namespaces>
        <ns prefix="sbdhNS">http://www.unece.org/cefact/namespaces/StandardBusinessDocumentHeader</ns>
        <ns prefix="f">http://hl7.org/fhir</ns>
    </namespaces>

    <steps>
        <assign to="httpHeaders{Content-Type}">"text/plain"</assign>
        <receive id="receiveEHMIMsg" desc="Receive EHMI SBDH Message through HTTP" from="EHMICorrespondent" to="SimulatedEHMICorrespondent" handler="HttpMessagingV2">
            <input name="uriExtension">"/receiveEHMISBDH-schema-validation"</input>
            <input name="method">"POST"</input>
            <input name="status">200</input>
            <input name="body">"Received"</input>
            <input name="headers">$httpHeaders</input>
        </receive>

        <log>"EHMI SBDH message received"</log>
        
        <verify handler="XmlValidator" desc="Basic Test: Validate EHMI SBDH XML Schema">
            <input name="xml">$receiveEHMIMsg{request}{body}</input>
            <input name="xsd">$EHMISBDHSchema</input>
        </verify>

        <assign to="binaryContent" source="$receiveEHMIMsg{request}{body}">
            //sbdhNS:BinaryContent/text()
        </assign>

        <process id="decodeBinaryContent" handler="Base64Processor" output="decodedBinaryContent" operation="decode">
            <input name="input">$binaryContent</input>
        </process>


        <assign to="binaryContentType" source="$receiveEHMIMsg{request}{body}">
            //sbdhNS:BinaryContent/@mimeType    
        </assign>
        <log>"Binary content type:" || $binaryContentType</log>
        
        <if desc="If binary content is XML">
            <cond>$binaryContentType = "application/fhir+xml"</cond>
            <then>
                <log>"Binary content is XML"</log>

                <assign to="parameters{expectedMessageType}" source="$decodedBinaryContent">
                    /f:Bundle/f:entry[1]/f:resource/f:MessageHeader/f:eventCoding/f:code/@value
                </assign>
                <log>"Message type:" || $parameters{expectedMessageType}</log>
                
                <process output="schematronTemplate" handler="TemplateProcessor">
                    <input name="parameters">$parameters</input>
                    <input name="template">$schematron</input>
                    <input name="syntax">'freemarker'</input>
                </process>
                
                <verify handler="XmlValidator" desc="Validate values based on binary content">
                    <input name="xml">$receiveEHMIMsg{request}{body}</input>
                    <input name="xsd">$EHMISBDHSchema</input>
                    <input name="schematron">$schematronTemplate</input>
                </verify>
                
                <exit success="true"></exit>
            </then>
            <else>
                <log>"Binary content is not XML"</log>
            </else>
        </if>
        
        <if desc="If binary content is JSON">
            <cond>$binaryContentType = "application/fhir+json"</cond>
            <then>
                <log>"Binary content is JSON"</log>
                <!-- TODO: Check if the Assign can be done the same way? How equivelant is xPATH and jsonPATH I wonder -->
                <exit success="true"></exit>
            </then>
            <else>
                <log>"Binary content is not JSON"</log>
            </else>
        </if>

        <exit desc="Binary Content Type was neither XML or JSON. Failure" success="false"/>
    </steps>

    <output>
        <success>
            <default>"Test session succeeded."</default>
        </success>
        <failure>
            <default>"Test session failed. Refer to the report for further details."</default>
        </failure>
    </output>

</testcase>