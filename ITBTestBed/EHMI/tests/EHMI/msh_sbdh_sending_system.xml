<?xml version="1.0" encoding="UTF-8"?>
<testcase 
    id="ehmi_msh_sending_system_test" 
    xmlns="http://www.gitb.com/tdl/v1/" 
    xmlns:gitb="http://www.gitb.com/core/v1/" 
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
    xsi:schemaLocation="http://www.gitb.com/tdl/v1/ ../../../testbedSchemas/gitb_tdl.xsd">    

    <metadata>
        <gitb:name>MSH SBDH Sending System Test</gitb:name>
        <gitb:version>1.0</gitb:version>
        <gitb:description>Tests an EHMI SBDH XML document for an MSH Sending System</gitb:description>
    </metadata>

    <imports>
        <artifact type="schema" encoding="UTF-8" name="EHMI_SBDH_schema">resources/EHMI/ehmiSbdhStandardBusinessDocumentHeader.xsd</artifact>
        <artifact type="binary" name="schematron">resources/EHMI/schematrons/ehmiSBDHSendingSystemAssertions.xslt</artifact>
    </imports>

    <actors>
        <gitb:actor id="EHMIMSHSendingSystem" name="EHMI MSH Sending System" role="SUT"/>
        <gitb:actor id="SimulatedEHMIMSHReceivingSystem" name="Simulated EHMI MSH Receiving System"/>
    </actors>

    <namespaces>
        <ns prefix="sbdhNS">http://www.unece.org/cefact/namespaces/StandardBusinessDocumentHeader</ns>
        <ns prefix="f">http://hl7.org/fhir</ns>
    </namespaces>

    <steps>
        <assign to="httpHeaders{Content-Type}">"text/plain"</assign>
        <receive id="receiveEHMIMsg" desc="EHMI MSH SBDH Message" from="EHMIMSHSendingSystem" to="SimulatedEHMIMSHReceivingSystem" handler="HttpMessagingV2">
            <input name="uriExtension">"/receive-msh-sbdh-ehmi-msg"</input>
            <input name="method">"POST"</input>
            <input name="status">200</input>
            <input name="body">"Received"</input>
            <input name="headers">$httpHeaders</input>
        </receive>

        <verify handler="XmlValidator" desc="Validate XML structure">
            <input name="xml">$receiveEHMIMsg{request}{body}</input>
            <input name="xsd">$EHMI_SBDH_schema</input>
            <input name="stopOnXsdErrors">true()</input>
        </verify>

        <assign to="binaryContent" source="$receiveEHMIMsg{request}{body}">
            //sbdhNS:BinaryContent/text()
        </assign>

        <process id="decodeBinaryContent" handler="Base64Processor" output="decodedBinaryContent" operation="decode">
            <input name="input">$binaryContent</input>
        </process>
        
        <assign to="binaryContentType" source="$receiveEHMIMsg{request}{body}">
            //sbdhNS:BinaryContent/@mimeType    
        </assign>
        
        <!-- Find values from BinaryContent -->
        <process id="expectedDocumentIdentifierStandard" handler="$DOMAIN{processingServiceAddress}" operation="FHIRPath">
            <input name="fhirResource">$decodedBinaryContent</input>
            <input name="fhirResourceType">$binaryContentType</input>
            <input name="fhirPathExpression">"entry.first().resource.ofType(MessageHeader).event.code"</input>
        </process>

        <assign to="parameters{expectedDocumentIdentifierStandard}" source="$decodedBinaryContent">
            $expectedDocumentIdentifierStandard{output}
        </assign>
        
        <process id="expectedMessageDefinitionVersion" handler="$DOMAIN{processingServiceAddress}" operation="FHIRPath">
            <input name="fhirResource">$decodedBinaryContent</input>
            <input name="fhirResourceType">$binaryContentType</input>
            <input name="fhirPathExpression">"entry.first().resource.ofType(MessageHeader).definition.replaceMatches('.*[dD]efinition([0-9.]+)$', '$1')"</input>
        </process>
        
        <assign to="parameters{expectedMessageDefinitionVersion}" source="$decodedBinaryContent">
            $expectedMessageDefinitionVersion{output}
        </assign>

        <process id="expectedStructureDefinition" handler="$DOMAIN{processingServiceAddress}" operation="FHIRPath">
            <input name="fhirResource">$decodedBinaryContent</input>
            <input name="fhirResourceType">$binaryContentType</input>
            <input name="fhirPathExpression">"meta.profile[0].split('/').last()"</input>
        </process>
        
        <assign to="parameters{expectedStructureDefinition}" source="$decodedBinaryContent">
            $expectedStructureDefinition{output}
        </assign>
        
        <process id="expectedPatientCPR" handler="$DOMAIN{processingServiceAddress}" operation="FHIRPath">
            <input name="fhirResource">$decodedBinaryContent</input>
            <input name="fhirResourceType">$binaryContentType</input>
            <input name="fhirPathExpression">"entry.resource.ofType(Patient).identifier.where(system = 'urn:oid:1.2.208.176.1.2').value"</input>
        </process>
        
        <assign to="parameters{expectedPatientCPR}" source="$decodedBinaryContent">
            $expectedPatientCPR{output}
        </assign>
        
        <process id="expectedSenderId" handler="$DOMAIN{processingServiceAddress}" operation="FHIRPath">
            <input name="fhirResource">$decodedBinaryContent</input>
            <input name="fhirResourceType">$binaryContentType</input>
            <input name="fhirPathExpression">"entry[0].resource.sender.resolve().identifier.where(system = 'urn:oid:1.2.208.176.1.1').value"</input>
        </process>
        
        <assign to="parameters{expectedSenderId}" source="$decodedBinaryContent">
            $expectedSenderId{output}
        </assign>
        
        <process id="expectedReceiverId" handler="$DOMAIN{processingServiceAddress}" operation="FHIRPath">
            <input name="fhirResource">$decodedBinaryContent</input>
            <input name="fhirResourceType">$binaryContentType</input>
            <input name="fhirPathExpression">"entry[0].resource.destination.receiver.resolve().identifier.where(system = 'urn:oid:1.2.208.176.1.1').value"</input>
        </process>
        
        <assign to="parameters{expectedReceiverId}" source="$decodedBinaryContent">
            $expectedReceiverId{output}
        </assign>
        
        <process id="expectedMessageIdentifier" handler="$DOMAIN{processingServiceAddress}" operation="FHIRPath">
            <input name="fhirResource">$decodedBinaryContent</input>
            <input name="fhirResourceType">$binaryContentType</input>
            <input name="fhirPathExpression">"entry[0].resource.id"</input>
        </process>
        
        <assign to="parameters{expectedMessageIdentifier}" source="$decodedBinaryContent">
            $expectedMessageIdentifier{output}
        </assign>
        
        <process id="expectedMessageEnvelopeIdentifier" handler="$DOMAIN{processingServiceAddress}" operation="FHIRPath">
            <input name="fhirResource">$decodedBinaryContent</input>
            <input name="fhirResourceType">$binaryContentType</input>
            <input name="fhirPathExpression">"id"</input>
        </process>
        
        <assign to="parameters{expectedMessageEnvelopeIdentifier}" source="$decodedBinaryContent">
            $expectedMessageEnvelopeIdentifier{output}
        </assign>

        <!-- Test -->
        
        <process output="schematronTemplate" handler="TemplateProcessor">
            <input name="parameters">$parameters</input>
            <input name="template">$schematron</input>
            <input name="syntax">'freemarker'</input>
        </process>
        
        <verify handler="XmlValidator" desc="Validate content">
            <input name="xml">$receiveEHMIMsg{request}{body}</input>
            <input name="xsd">$EHMI_SBDH_schema</input>
            <input name="schematron">$schematronTemplate</input>
            <input name="schematronType">'xslt'</input>
        </verify>
    </steps>

    <output>
        <success>
            <default>"Test session succeeded."</default>
        </success>
        <failure>
            <default>"Test session failed. Refer to the report for further details."</default>
        </failure>
    </output>

</testcase>